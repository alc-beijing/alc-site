{{ define "main" }}
<!-- 页面头部 -->
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            {{ .Title }}
            <span class="current-page-indicator">
                <i class="fas fa-map-marker-alt"></i>
                当前页面
            </span>
        </h1>
        {{ if .Description }}
        <p class="page-description">{{ .Description }}</p>
        {{ end }}
        <div class="page-stats">
            <span class="stats-item">
                <i class="fas fa-file-alt"></i>
                {{ .Paginator.TotalNumberOfElements }} 篇文章
            </span>
            {{ if .Site.Taxonomies.categories }}
            <span class="stats-item">
                <i class="fas fa-folder"></i>
                {{ len .Site.Taxonomies.categories }} 个分类
            </span>
            {{ end }}
            {{ if .Site.Taxonomies.tags }}
            <span class="stats-item">
                <i class="fas fa-tags"></i>
                {{ len .Site.Taxonomies.tags }} 个标签
            </span>
            {{ end }}
        </div>
    </div>
</div>

<div class="container">
    <!-- 搜索框 -->
    <div class="search-section">
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="搜索文章标题、描述、作者..." id="searchInput">
            <button class="search-clear" id="searchClear" style="display: none;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="search-suggestions" id="searchSuggestions" style="display: none;">
            <div class="suggestions-header">
                <i class="fas fa-lightbulb"></i>
                <span>搜索建议</span>
            </div>
            <div class="suggestions-list" id="suggestionsList"></div>
        </div>
    </div>

    <!-- 标签筛选器 -->
    <div class="tags-filter">
        <div class="filter-section">
            <h3 class="filter-title" onclick="toggleFilter(this)">
                分类浏览
                <i class="fas fa-chevron-down filter-expand-icon" title="点击展开"></i>
            </h3>
            <div class="filter-tags">
                <button class="filter-tag active" data-filter="all" data-type="category">全部文章</button>
                {{ range $name, $taxonomy := .Site.Taxonomies.categories }}
                <button class="filter-tag" data-filter="{{ $name | lower }}" data-type="category">
                    {{ $name }}
                </button>
                {{ end }}
            </div>
        </div>
        
        <div class="filter-section">
            <h3 class="filter-title" onclick="toggleFilter(this)">
                标签浏览
                <i class="fas fa-chevron-down filter-expand-icon" title="点击展开"></i>
            </h3>
            <div class="filter-tags">
                <button class="filter-tag active" data-filter="all" data-type="tag">全部标签</button>
                {{ range $name, $taxonomy := .Site.Taxonomies.tags }}
                <button class="filter-tag" data-filter="{{ $name | lower }}" data-type="tag">
                    {{ $name }}
                </button>
                {{ end }}
            </div>
        </div>
    </div>

    <!-- 文章列表 -->
    <div class="posts-container">
        <div class="posts-grid" id="postsGrid">
            {{ range .Paginator.Pages }}
            <article class="post-card" 
                     data-title="{{ .Title | lower }}"
                     data-description="{{ if .Description }}{{ .Description | lower }}{{ else }}{{ .Summary | plainify | lower }}{{ end }}"
                     data-author="{{ if .Params.author }}{{ .Params.author | lower }}{{ end }}"
                     data-category="{{ if .Params.categories }}{{ delimit .Params.categories " " | lower }}{{ end }}"
                     data-tags="{{ if .Params.tags }}{{ delimit .Params.tags " " | lower }}{{ end }}"
                     data-date="{{ .Date.Format "2006-01-02" }}">
                
                <div class="post-card-content">
                    <div class="post-card-body">
                        <header class="post-card-header">
                            <h2 class="post-card-title">
                                <a href="{{ .RelPermalink }}">{{ .Title }}</a>
                            </h2>
                            {{ if .Description }}
                            <p class="post-card-excerpt">{{ .Description }}</p>
                            {{ else }}
                            <p class="post-card-excerpt">{{ .Summary | plainify | truncate 100 }}</p>
                            {{ end }}
                            {{ if .Params.author }}
                            <span class="post-author">
                                <i class="fas fa-user"></i>
                                {{ .Params.author }}
                            </span>
                            {{ end }}
                        </header>
                        
                        <footer class="post-card-footer">
                            <time class="post-date" datetime="{{ .Date.Format "2006-01-02" }}">
                                <i class="fas fa-calendar-alt"></i>
                                {{ .Date.Format "2006年1月2日" }}
                            </time>
                            <a href="{{ .RelPermalink }}" class="read-more">阅读更多</a>
                        </footer>
                    </div>
                </div>
            </article>
            {{ end }}
        </div>
        
        <!-- 无结果提示 -->
        <div class="no-results" id="noResults" style="display: none;">
            <div class="no-results-content">
                <i class="fas fa-search"></i>
                <h3>没有找到相关文章</h3>
                <p>请尝试调整搜索关键词</p>
                <button class="btn btn-primary" onclick="clearSearch()">清除搜索</button>
            </div>
        </div>
    </div>
    
    <!-- 分页 -->
    {{ if or (.Paginator.HasPrev) (.Paginator.HasNext) }}
    <div class="pagination-container">
        {{ template "_internal/pagination.html" . }}
    </div>
    {{ end }}
</div>

<!-- 列表页专用JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const searchClear = document.getElementById('searchClear');
    const postsGrid = document.getElementById('postsGrid');
    const noResults = document.getElementById('noResults');
    const posts = document.querySelectorAll('.post-card');
    
    let searchTerm = '';
    
    // 搜索功能
    searchInput.addEventListener('input', function() {
        searchTerm = this.value.toLowerCase().trim();
        
        if (searchTerm) {
            searchClear.style.display = 'block';
            showSearchSuggestions(searchTerm);
        } else {
            searchClear.style.display = 'none';
            hideSearchSuggestions();
        }
        
        filterPosts();
    });
    
    // 显示搜索建议
    function showSearchSuggestions(term) {
        const suggestions = [];
        const seen = new Set();
        
        posts.forEach(post => {
            const title = post.dataset.title;
            const description = post.dataset.description || '';
            const author = post.dataset.author || '';
            
            // 从标题中提取建议
            if (title.includes(term) && !seen.has(title)) {
                suggestions.push({
                    text: title,
                    type: '标题',
                    icon: 'fas fa-heading'
                });
                seen.add(title);
            }
            
            // 从作者中提取建议
            if (author && author.includes(term) && !seen.has(author)) {
                suggestions.push({
                    text: author,
                    type: '作者',
                    icon: 'fas fa-user'
                });
                seen.add(author);
            }
            
            // 从描述中提取关键词
            const words = description.split(/\s+/);
            words.forEach(word => {
                if (word.includes(term) && word.length > 2 && !seen.has(word)) {
                    suggestions.push({
                        text: word,
                        type: '关键词',
                        icon: 'fas fa-tag'
                    });
                    seen.add(word);
                }
            });
        });
        
        // 限制建议数量
        suggestions.splice(5);
        
        if (suggestions.length > 0) {
            displaySuggestions(suggestions);
        } else {
            hideSearchSuggestions();
        }
    }
    
    // 显示建议列表
    function displaySuggestions(suggestions) {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        const suggestionsList = document.getElementById('suggestionsList');
        
        suggestionsList.innerHTML = '';
        
        suggestions.forEach(suggestion => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.innerHTML = `
                <i class="${suggestion.icon} suggestion-icon"></i>
                <span class="suggestion-text">${suggestion.text}</span>
                <span class="suggestion-type">${suggestion.type}</span>
            `;
            
            item.addEventListener('click', () => {
                searchInput.value = suggestion.text;
                searchTerm = suggestion.text.toLowerCase();
                hideSearchSuggestions();
                filterPosts();
            });
            
            suggestionsList.appendChild(item);
        });
        
        suggestionsContainer.style.display = 'block';
    }
    
    // 隐藏搜索建议
    function hideSearchSuggestions() {
        const suggestionsContainer = document.getElementById('searchSuggestions');
        suggestionsContainer.style.display = 'none';
    }
    
    // 点击外部区域隐藏搜索建议
    document.addEventListener('click', function(e) {
        const searchContainer = document.querySelector('.search-container');
        const suggestionsContainer = document.getElementById('searchSuggestions');
        
        if (!searchContainer.contains(e.target) && !suggestionsContainer.contains(e.target)) {
            hideSearchSuggestions();
        }
    });
    
    // 清除搜索
    searchClear.addEventListener('click', function() {
        searchInput.value = '';
        searchTerm = '';
        searchClear.style.display = 'none';
        hideSearchSuggestions();
        filterPosts();
    });
    
    // 标签筛选器交互
    const filterTags = document.querySelectorAll('.filter-tag');
    let currentCategoryFilter = 'all';
    let currentTagFilter = 'all';
    
    filterTags.forEach(tag => {
        tag.addEventListener('click', function(e) {
            e.preventDefault();
            
            const filterType = this.dataset.type;
            const filterValue = this.dataset.filter;
            
            // 移除同类型的所有active类
            filterTags.forEach(t => {
                if (t.dataset.type === filterType) {
                    t.classList.remove('active');
                }
            });
            
            // 添加active类到当前点击的标签
            this.classList.add('active');
            
            // 更新筛选状态
            if (filterType === 'category') {
                currentCategoryFilter = filterValue;
            } else if (filterType === 'tag') {
                currentTagFilter = filterValue;
            }
            
            // 执行筛选
            filterPosts();
        });
    });
    
    // 统一的筛选函数
    function filterPosts() {
        let visibleCount = 0;
        
        posts.forEach(post => {
            const title = post.dataset.title;
            const description = post.dataset.description || '';
            const author = post.dataset.author || '';
            const category = post.dataset.category || '';
            const tags = post.dataset.tags || '';
            
            // 检查搜索条件 - 搜索标题、描述、作者
            const matchesSearch = !searchTerm || 
                                 title.includes(searchTerm) || 
                                 description.includes(searchTerm) || 
                                 author.includes(searchTerm);
            
            // 检查分类条件
            const matchesCategory = currentCategoryFilter === 'all' || 
                                  category.includes(currentCategoryFilter);
            
            // 检查标签条件
            const matchesTag = currentTagFilter === 'all' || 
                             tags.includes(currentTagFilter);
            
            if (matchesSearch && matchesCategory && matchesTag) {
                post.style.display = 'block';
                visibleCount++;
                
                // 如果有搜索词，添加高亮效果
                if (searchTerm) {
                    post.classList.add('search-highlight');
                } else {
                    post.classList.remove('search-highlight');
                }
            } else {
                post.style.display = 'none';
                post.classList.remove('search-highlight');
            }
        });
        
        // 显示/隐藏无结果提示
        if (visibleCount === 0 && (searchTerm || currentCategoryFilter !== 'all' || currentTagFilter !== 'all')) {
            noResults.style.display = 'block';
        } else {
            noResults.style.display = 'none';
        }
        
        // 更新搜索结果统计
        updateSearchStats(visibleCount);
    }
    
    // 更新搜索统计信息
    function updateSearchStats(visibleCount) {
        const totalCount = posts.length;
        const statsContainer = document.querySelector('.page-stats');
        
        if (statsContainer) {
            const statsItem = statsContainer.querySelector('.stats-item');
            if (statsItem) {
                if (searchTerm || currentCategoryFilter !== 'all' || currentTagFilter !== 'all') {
                    statsItem.innerHTML = `<i class="fas fa-file-alt"></i> 显示 ${visibleCount} 篇文章 (共 ${totalCount} 篇)`;
                } else {
                    statsItem.innerHTML = `<i class="fas fa-file-alt"></i> ${totalCount} 篇文章`;
                }
            }
        }
    }
    
    // 清除搜索函数（供外部调用）
    window.clearSearch = function() {
        searchInput.value = '';
        searchTerm = '';
        searchClear.style.display = 'none';
        hideSearchSuggestions();
        filterPosts();
    };
    
    // 设置当前导航高亮
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-link');
    
    navLinks.forEach(link => {
        if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
        }
    });
    
    // 展开/收起筛选器功能
    window.toggleFilter = function(titleElement) {
        const filterSection = titleElement.closest('.filter-section');
        const filterTags = filterSection.querySelector('.filter-tags');
        
        if (filterTags.classList.contains('expanded')) {
            filterTags.classList.remove('expanded');
            filterSection.classList.remove('expanded');
        } else {
            filterTags.classList.add('expanded');
            filterSection.classList.add('expanded');
        }
    };
});
</script>
{{ end }} 
